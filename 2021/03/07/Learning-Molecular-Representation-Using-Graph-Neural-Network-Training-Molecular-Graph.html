<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Learning Molecular Representation using Graph Neural Network - Training Molecular Graph | Sunhwan Jo</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Learning Molecular Representation using Graph Neural Network - Training Molecular Graph" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Taking a look at how graph neural network operate for molecular representations" />
<meta property="og:description" content="Taking a look at how graph neural network operate for molecular representations" />
<link rel="canonical" href="https://sunhwan.github.io/blog/2021/03/07/Learning-Molecular-Representation-Using-Graph-Neural-Network-Training-Molecular-Graph.html" />
<meta property="og:url" content="https://sunhwan.github.io/blog/2021/03/07/Learning-Molecular-Representation-Using-Graph-Neural-Network-Training-Molecular-Graph.html" />
<meta property="og:site_name" content="Sunhwan Jo" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-03-07T00:00:00-06:00" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"https://sunhwan.github.io/blog/2021/03/07/Learning-Molecular-Representation-Using-Graph-Neural-Network-Training-Molecular-Graph.html"},"url":"https://sunhwan.github.io/blog/2021/03/07/Learning-Molecular-Representation-Using-Graph-Neural-Network-Training-Molecular-Graph.html","@type":"BlogPosting","headline":"Learning Molecular Representation using Graph Neural Network - Training Molecular Graph","dateModified":"2021-03-07T00:00:00-06:00","datePublished":"2021-03-07T00:00:00-06:00","description":"Taking a look at how graph neural network operate for molecular representations","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/blog/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://sunhwan.github.io/blog/feed.xml" title="Sunhwan Jo" /><link rel="shortcut icon" type="image/x-icon" href="/blog/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/blog/">Sunhwan Jo</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/blog/about/">About Me</a><a class="page-link" href="/blog/search/">Search</a><a class="page-link" href="/blog/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Learning Molecular Representation using Graph Neural Network - Training Molecular Graph</h1><p class="page-description">Taking a look at how graph neural network operate for molecular representations</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-03-07T00:00:00-06:00" itemprop="datePublished">
        Mar 7, 2021
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      24 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/blog/categories/#rdkit">rdkit</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#machine learning">machine learning</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#graph neural network">graph neural network</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/sunhwan/blog/tree/master/_notebooks/2021-03-07-Learning-Molecular-Representation-Using-Graph-Neural-Network-Training-Molecular-Graph.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/blog/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/sunhwan/blog/master?filepath=_notebooks%2F2021-03-07-Learning-Molecular-Representation-Using-Graph-Neural-Network-Training-Molecular-Graph.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/blog/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/sunhwan/blog/blob/master/_notebooks/2021-03-07-Learning-Molecular-Representation-Using-Graph-Neural-Network-Training-Molecular-Graph.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/blog/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#Motivation">Motivation </a></li>
<li class="toc-entry toc-h1"><a href="#Recap">Recap </a></li>
<li class="toc-entry toc-h1"><a href="#Train-Data">Train Data </a></li>
<li class="toc-entry toc-h1"><a href="#MPNN-Model">MPNN Model </a></li>
<li class="toc-entry toc-h1"><a href="#Train-the-MPNN">Train the MPNN </a></li>
<li class="toc-entry toc-h1"><a href="#Conclusion">Conclusion </a></li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2021-03-07-Learning-Molecular-Representation-Using-Graph-Neural-Network-Training-Molecular-Graph.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Motivation">
<a class="anchor" href="#Motivation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Motivation<a class="anchor-link" href="#Motivation"> </a>
</h1>
<p>In the <a href="https://sunhwan.github.io/blog/2021/02/20/Learning-Molecular-Representation-Using-Graph-Neural-Network-Molecular-Graph.html">previous post</a>, I have looked into how a molecular graph is constructed and message can be passed around in a MPNN architecture. In this post, I'll take a look at how the graph neural net can be trained. The details of message passing update will vary by implementation; here we choose what was used in this <a href="http://dx.doi.org/10.1021/acs.jcim.9b00237">paper</a>.</p>
<p>Again, many code examples were taken from <a href="https://github.com/chemprop/chemprop">chemprop</a> repository. The code was initially taken from the chemprop repository and I edited them for the sake of simplicity.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Recap">
<a class="anchor" href="#Recap" aria-hidden="true"><span class="octicon octicon-link"></span></a>Recap<a class="anchor-link" href="#Recap"> </a>
</h1>
<p><img src="/blog/images/copied_from_nb/files/molecular_graph_features.png" alt="feature"></p>
<p>Let's briefly recap how the molecular graph is constructed and messages are passed around. As shown in the above figure, each atom and bonds are labeled as $x$ and $e$. Here we are discussing D-MPNN, which represents the graph with a directional edges, which means, for each bond between two atoms $v$ and $w$, there are two directional bond, $e_{vw}$ and $e_{wv}$.</p>
<p>The initial hidden message is constructed as $h_{vw}^0 = \tau (W_i \mathrm{cat}(x_v, e_{vw}))$ where $W_i$ is a learned matrix and $\tau$ is an activation function.</p>
<p><img src="/blog/images/copied_from_nb/files/molecular_graph_message.png" alt="message"></p>
<p>Above figure shows two messages, $m_{57}$ and $m_{54}$, are constructed. First, the message from atom $v$ to $w$ is the sum of all the hidden state for the incoming bonds to $v$ (excluding the one originating from $w$). Then the learned matrix $W_m$ is multiplied to the message and the initial hidden message is added to form the new hidden message for the depth 1. This is repeated several times for the message to be passed around to multiple depth.</p>
<p>After the messages are passed up to the given number of depth, the hidden states are summed to be a final message per each atom (all incoming hidden state) and the hidden state for each atom is computed as follows:</p>
<p>
$$m_v = \sum_{k \in N(v)} h_{kv}^t$$
</p>
<p>
$$h_v = \tau(W_a \mathrm{cat} (x_v, m_v))$$
</p>
<p>Finally, the readout phase uses the sum of all $h_v$ to obtain the feature vector of the molecule and property prediction is carried out using a fully-connected feed forward network.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Train-Data">
<a class="anchor" href="#Train-Data" aria-hidden="true"><span class="octicon octicon-link"></span></a>Train Data<a class="anchor-link" href="#Train-Data"> </a>
</h1>
<p>As an example, I'll use Enamine Real's diversity discovery set composed of 10240 compounds. This dataset contains some molecular properties, such as ClogP and TPSA, so we should be able to train a GCNN that predicts those properties.</p>
<p>For this example, let's train using ClogP values.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>

<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">SVG</span>

<span class="c1"># RDKit </span>
<span class="kn">import</span> <span class="nn">rdkit</span>
<span class="kn">from</span> <span class="nn">rdkit.Chem</span> <span class="kn">import</span> <span class="n">PandasTools</span>
<span class="kn">from</span> <span class="nn">rdkit</span> <span class="kn">import</span> <span class="n">Chem</span>
<span class="kn">from</span> <span class="nn">rdkit.Chem</span> <span class="kn">import</span> <span class="n">AllChem</span>
<span class="kn">from</span> <span class="nn">rdkit.Chem</span> <span class="kn">import</span> <span class="n">DataStructs</span>
<span class="kn">from</span> <span class="nn">rdkit.Chem</span> <span class="kn">import</span> <span class="n">rdMolDescriptors</span>
<span class="kn">from</span> <span class="nn">rdkit.Chem</span> <span class="kn">import</span> <span class="n">rdRGroupDecomposition</span>
<span class="kn">from</span> <span class="nn">rdkit.Chem.Draw</span> <span class="kn">import</span> <span class="n">IPythonConsole</span> <span class="c1">#Needed to show molecules</span>
<span class="kn">from</span> <span class="nn">rdkit.Chem</span> <span class="kn">import</span> <span class="n">Draw</span>
<span class="kn">from</span> <span class="nn">rdkit.Chem</span> <span class="kn">import</span> <span class="n">rdDepictor</span>
<span class="kn">from</span> <span class="nn">rdkit.Chem.Draw</span> <span class="kn">import</span> <span class="n">rdMolDraw2D</span>
<span class="kn">from</span> <span class="nn">rdkit.Chem.Draw.MolDrawing</span> <span class="kn">import</span> <span class="n">MolDrawing</span><span class="p">,</span> <span class="n">DrawingOptions</span> <span class="c1">#Only needed if modifying defaults</span>

<span class="n">DrawingOptions</span><span class="o">.</span><span class="n">bondLineWidth</span><span class="o">=</span><span class="mf">1.8</span>
<span class="n">IPythonConsole</span><span class="o">.</span><span class="n">ipython_useSVG</span><span class="o">=</span><span class="kc">True</span>
<span class="kn">from</span> <span class="nn">rdkit</span> <span class="kn">import</span> <span class="n">RDLogger</span>
<span class="n">RDLogger</span><span class="o">.</span><span class="n">DisableLog</span><span class="p">(</span><span class="s1">'rdApp.warning'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rdkit</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>

<span class="c1"># pytorch</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">Sampler</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>

<span class="c1"># misc</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="nn">tqdm.notebook</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>2020.03.2
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># we will define a class which holds various parameter for D-MPNN</span>
<span class="k">class</span> <span class="nc">TrainArgs</span><span class="p">:</span>
    <span class="n">smiles_column</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">no_cuda</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">gpu</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">num_workers</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">no_cache_mol</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">dataset_type</span> <span class="o">=</span> <span class="s1">'regression'</span>
    <span class="n">task_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">seed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">hidden_size</span> <span class="o">=</span> <span class="mi">300</span>
    <span class="n">bias</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">dropout</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">undirected</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">aggregation</span> <span class="o">=</span> <span class="s1">'mean'</span>
    <span class="n">aggregation_norm</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">ffn_num_layers</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">ffn_hidden_size</span> <span class="o">=</span> <span class="mi">300</span>
    <span class="n">init_lr</span> <span class="o">=</span> <span class="mf">1e-4</span>
    <span class="n">max_lr</span> <span class="o">=</span> <span class="mf">1e-3</span>
    <span class="n">final_lr</span> <span class="o">=</span> <span class="mf">1e-4</span>
    <span class="n">num_lrs</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">warmup_epochs</span> <span class="o">=</span> <span class="mf">2.0</span>
    <span class="n">epochs</span> <span class="o">=</span> <span class="mi">30</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">device</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">:</span>
        <span class="sd">"""The :code:`torch.device` on which to load and process data and models."""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cuda</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">'cpu'</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">'cuda'</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>

    <span class="nd">@device</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cuda</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">'cuda'</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gpu</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">index</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cuda</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">"""Whether to use CUDA (i.e., GPUs) or not."""</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_cuda</span> <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span>

    <span class="nd">@cuda</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">cuda</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cuda</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_cuda</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">cuda</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">args</span> <span class="o">=</span> <span class="n">TrainArgs</span><span class="p">()</span>
<span class="n">args</span><span class="o">.</span><span class="n">data_path</span> <span class="o">=</span> <span class="s1">'files/enamine_discovery_diversity_set_10240.csv'</span>
<span class="n">args</span><span class="o">.</span><span class="n">target_column</span> <span class="o">=</span> <span class="s1">'ClogP'</span>
<span class="n">args</span><span class="o">.</span><span class="n">smiles_column</span> <span class="o">=</span> <span class="s1">'SMILES'</span>
<span class="n">args</span><span class="o">.</span><span class="n">dataset_type</span> <span class="o">=</span> <span class="s1">'regression'</span>
<span class="n">args</span><span class="o">.</span><span class="n">task_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">target_column</span><span class="p">]</span>
<span class="n">args</span><span class="o">.</span><span class="n">num_tasks</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">data_path</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Name</th>
      <th>SMILES</th>
      <th>Catalog ID</th>
      <th>PlateID</th>
      <th>Well</th>
      <th>MW (desalted)</th>
      <th>ClogP</th>
      <th>HBD</th>
      <th>TPSA</th>
      <th>RotBonds</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>NaN</td>
      <td>CN(C(=O)NC1CCOc2ccccc21)C(c1ccccc1)c1ccccn1</td>
      <td>Z447596076</td>
      <td>1186474-R-001</td>
      <td>A02</td>
      <td>373.448</td>
      <td>2.419</td>
      <td>1</td>
      <td>54.46</td>
      <td>4</td>
    </tr>
    <tr>
      <th>1</th>
      <td>NaN</td>
      <td>Cn1cc(C(=O)N2CCC(OC3CCOC3)CC2)c(C2CC2)n1</td>
      <td>Z2180753156</td>
      <td>1186474-R-001</td>
      <td>A03</td>
      <td>319.399</td>
      <td>-0.570</td>
      <td>0</td>
      <td>56.59</td>
      <td>4</td>
    </tr>
    <tr>
      <th>2</th>
      <td>NaN</td>
      <td>CC(=O)N(C)C1CCN(C(=O)c2ccccc2-c2ccccc2C(=O)O)CC1</td>
      <td>Z2295858832</td>
      <td>1186474-R-001</td>
      <td>A04</td>
      <td>380.437</td>
      <td>0.559</td>
      <td>1</td>
      <td>77.92</td>
      <td>4</td>
    </tr>
    <tr>
      <th>3</th>
      <td>NaN</td>
      <td>COCC1(CNc2cnccc2C#N)CCNCC1</td>
      <td>Z2030994006</td>
      <td>1186474-R-001</td>
      <td>A05</td>
      <td>260.335</td>
      <td>0.902</td>
      <td>2</td>
      <td>69.97</td>
      <td>5</td>
    </tr>
    <tr>
      <th>4</th>
      <td>NaN</td>
      <td>CCCCOc1ccc(-c2nnc3n2CCCC3)cc1OC</td>
      <td>Z273627850</td>
      <td>1186474-R-001</td>
      <td>A06</td>
      <td>301.383</td>
      <td>3.227</td>
      <td>0</td>
      <td>49.17</td>
      <td>6</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">Random</span>

<span class="c1"># Cache of graph featurizations</span>
<span class="n">CACHE_GRAPH</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">SMILES_TO_GRAPH</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">def</span> <span class="nf">cache_graph</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">CACHE_GRAPH</span>

<span class="k">def</span> <span class="nf">set_cache_graph</span><span class="p">(</span><span class="n">cache_graph</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">CACHE_GRAPH</span>
    <span class="n">CACHE_GRAPH</span> <span class="o">=</span> <span class="n">cache_graph</span>

<span class="c1"># Cache of RDKit molecules</span>
<span class="n">CACHE_MOL</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">SMILES_TO_MOL</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Chem</span><span class="o">.</span><span class="n">Mol</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">def</span> <span class="nf">cache_mol</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">"""Returns whether RDKit molecules will be cached."""</span>
    <span class="k">return</span> <span class="n">CACHE_MOL</span>

<span class="k">def</span> <span class="nf">set_cache_mol</span><span class="p">(</span><span class="n">cache_mol</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">"""Sets whether RDKit molecules will be cached."""</span>
    <span class="k">global</span> <span class="n">CACHE_MOL</span>
    <span class="n">CACHE_MOL</span> <span class="o">=</span> <span class="n">cache_mol</span>
    
<span class="c1"># Atom feature sizes</span>
<span class="n">MAX_ATOMIC_NUM</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">ATOM_FEATURES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'atomic_num'</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">MAX_ATOMIC_NUM</span><span class="p">)),</span>
    <span class="s1">'degree'</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
    <span class="s1">'formal_charge'</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="s1">'chiral_tag'</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
    <span class="s1">'num_Hs'</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
    <span class="s1">'hybridization'</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">HybridizationType</span><span class="o">.</span><span class="n">SP</span><span class="p">,</span>
        <span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">HybridizationType</span><span class="o">.</span><span class="n">SP2</span><span class="p">,</span>
        <span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">HybridizationType</span><span class="o">.</span><span class="n">SP3</span><span class="p">,</span>
        <span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">HybridizationType</span><span class="o">.</span><span class="n">SP3D</span><span class="p">,</span>
        <span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">HybridizationType</span><span class="o">.</span><span class="n">SP3D2</span>
    <span class="p">],</span>
<span class="p">}</span>

<span class="c1"># Distance feature sizes</span>
<span class="n">PATH_DISTANCE_BINS</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="n">THREE_D_DISTANCE_MAX</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">THREE_D_DISTANCE_STEP</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">THREE_D_DISTANCE_BINS</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">THREE_D_DISTANCE_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">THREE_D_DISTANCE_STEP</span><span class="p">))</span>

<span class="c1"># len(choices) + 1 to include room for uncommon values; + 2 at end for IsAromatic and mass</span>
<span class="n">ATOM_FDIM</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">choices</span> <span class="ow">in</span> <span class="n">ATOM_FEATURES</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">+</span> <span class="mi">2</span>
<span class="n">EXTRA_ATOM_FDIM</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">BOND_FDIM</span> <span class="o">=</span> <span class="mi">14</span>


<span class="k">def</span> <span class="nf">get_atom_fdim</span><span class="p">():</span>
    <span class="sd">"""Gets the dimensionality of the atom feature vector."""</span>
    <span class="k">return</span> <span class="n">ATOM_FDIM</span> <span class="o">+</span> <span class="n">EXTRA_ATOM_FDIM</span>

<span class="k">def</span> <span class="nf">get_bond_fdim</span><span class="p">(</span><span class="n">atom_messages</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">"""Gets the dimensionality of the bond feature vector.</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">BOND_FDIM</span> <span class="o">+</span> <span class="p">(</span><span class="ow">not</span> <span class="n">atom_messages</span><span class="p">)</span> <span class="o">*</span> <span class="n">get_atom_fdim</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">onek_encoding_unk</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">choices</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span>
    <span class="n">encoding</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">choices</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">choices</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">encoding</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">encoding</span>

<span class="k">def</span> <span class="nf">atom_features</span><span class="p">(</span><span class="n">atom</span><span class="p">:</span> <span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">Atom</span><span class="p">,</span> <span class="n">functional_groups</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Builds a feature vector for an atom.</span>
<span class="sd">    """</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">onek_encoding_unk</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">GetAtomicNum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ATOM_FEATURES</span><span class="p">[</span><span class="s1">'atomic_num'</span><span class="p">])</span> <span class="o">+</span> \
               <span class="n">onek_encoding_unk</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">GetTotalDegree</span><span class="p">(),</span> <span class="n">ATOM_FEATURES</span><span class="p">[</span><span class="s1">'degree'</span><span class="p">])</span> <span class="o">+</span> \
               <span class="n">onek_encoding_unk</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">GetFormalCharge</span><span class="p">(),</span> <span class="n">ATOM_FEATURES</span><span class="p">[</span><span class="s1">'formal_charge'</span><span class="p">])</span> <span class="o">+</span> \
               <span class="n">onek_encoding_unk</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">GetChiralTag</span><span class="p">()),</span> <span class="n">ATOM_FEATURES</span><span class="p">[</span><span class="s1">'chiral_tag'</span><span class="p">])</span> <span class="o">+</span> \
               <span class="n">onek_encoding_unk</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">GetTotalNumHs</span><span class="p">()),</span> <span class="n">ATOM_FEATURES</span><span class="p">[</span><span class="s1">'num_Hs'</span><span class="p">])</span> <span class="o">+</span> \
               <span class="n">onek_encoding_unk</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">GetHybridization</span><span class="p">()),</span> <span class="n">ATOM_FEATURES</span><span class="p">[</span><span class="s1">'hybridization'</span><span class="p">])</span> <span class="o">+</span> \
               <span class="p">[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">GetIsAromatic</span><span class="p">()</span> <span class="k">else</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> \
               <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">GetMass</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.01</span><span class="p">]</span>  <span class="c1"># scaled to about the same range as other features</span>
    <span class="k">if</span> <span class="n">functional_groups</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">features</span> <span class="o">+=</span> <span class="n">functional_groups</span>
    <span class="k">return</span> <span class="n">features</span>

<span class="k">def</span> <span class="nf">bond_features</span><span class="p">(</span><span class="n">bond</span><span class="p">:</span> <span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">Bond</span><span class="p">):</span>
    <span class="sd">"""Builds a feature vector for a bond.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">bond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fbond</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">BOND_FDIM</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bt</span> <span class="o">=</span> <span class="n">bond</span><span class="o">.</span><span class="n">GetBondType</span><span class="p">()</span>
        <span class="n">fbond</span> <span class="o">=</span> <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>  <span class="c1"># bond is not None</span>
            <span class="n">bt</span> <span class="o">==</span> <span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">BondType</span><span class="o">.</span><span class="n">SINGLE</span><span class="p">,</span>
            <span class="n">bt</span> <span class="o">==</span> <span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">BondType</span><span class="o">.</span><span class="n">DOUBLE</span><span class="p">,</span>
            <span class="n">bt</span> <span class="o">==</span> <span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">BondType</span><span class="o">.</span><span class="n">TRIPLE</span><span class="p">,</span>
            <span class="n">bt</span> <span class="o">==</span> <span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">BondType</span><span class="o">.</span><span class="n">AROMATIC</span><span class="p">,</span>
            <span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">GetIsConjugated</span><span class="p">()</span> <span class="k">if</span> <span class="n">bt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span><span class="p">),</span>
            <span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">IsInRing</span><span class="p">()</span> <span class="k">if</span> <span class="n">bt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">fbond</span> <span class="o">+=</span> <span class="n">onek_encoding_unk</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">GetStereo</span><span class="p">()),</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">fbond</span>
    
<span class="k">class</span> <span class="nc">MoleculeDatapoint</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">smiles</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">targets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">row</span><span class="p">:</span> <span class="n">OrderedDict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">smiles</span> <span class="o">=</span> <span class="n">smiles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">=</span> <span class="n">row</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mol</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Chem</span><span class="o">.</span><span class="n">Mol</span><span class="p">:</span>
        <span class="sd">"""Gets the corresponding list of RDKit molecules for the corresponding SMILES."""</span>
        <span class="n">mol</span> <span class="o">=</span> <span class="n">SMILES_TO_MOL</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">,</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">cache_mol</span><span class="p">():</span>
            <span class="n">SMILES_TO_MOL</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">]</span> <span class="o">=</span> <span class="n">mol</span>
        <span class="k">return</span> <span class="n">mol</span>

    <span class="k">def</span> <span class="nf">set_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""Sets the features of the molecule.</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span>

    <span class="k">def</span> <span class="nf">extend_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""Extends the features of the molecule.</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">features</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">features</span>

    <span class="k">def</span> <span class="nf">num_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">"""Returns the number of prediction tasks.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_targets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]]):</span>
        <span class="sd">"""Sets the targets of a molecule.</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span>

    <span class="k">def</span> <span class="nf">reset_features_and_targets</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""Resets the features and targets to their raw values."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_features</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_targets</span>
        
        
<span class="k">class</span> <span class="nc">MoleculeDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MoleculeDatapoint</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scaler</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batch_graph</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_random</span> <span class="o">=</span> <span class="n">Random</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">smiles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">smiles</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">mols</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Chem</span><span class="o">.</span><span class="n">Mol</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">mol</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">targets</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">targets</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">num_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">num_tasks</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">set_targets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_targets</span><span class="p">(</span><span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">reset_features_and_targets</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
            <span class="n">d</span><span class="o">.</span><span class="n">reset_features_and_targets</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">MoleculeDatapoint</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">MoleculeDatapoint</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">batch_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_graph</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_batch_graph</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">mol_graphs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
                <span class="n">mol_graphs_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">smiles</span> <span class="ow">in</span> <span class="n">SMILES_TO_GRAPH</span><span class="p">:</span>
                    <span class="n">mol_graph</span> <span class="o">=</span> <span class="n">SMILES_TO_GRAPH</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">smiles</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mol_graph</span> <span class="o">=</span> <span class="n">MolGraph</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">mol</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">cache_graph</span><span class="p">():</span>
                        <span class="n">SMILES_TO_GRAPH</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">smiles</span><span class="p">]</span> <span class="o">=</span> <span class="n">mol_graph</span>
                <span class="n">mol_graphs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">mol_graph</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_batch_graph</span> <span class="o">=</span> <span class="p">[</span><span class="n">BatchMolGraph</span><span class="p">([</span><span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">mol_graphs</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mol_graphs</span><span class="p">[</span><span class="mi">0</span><span class="p">]))]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_graph</span>
    
    <span class="k">def</span> <span class="nf">features</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">"""</span>
<span class="sd">        Returns the features associated with each molecule (if they exist).</span>

<span class="sd">        :return: A list of 1D numpy arrays containing the features for each molecule or None if there are no features.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">features</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">]</span>
    

<span class="k">def</span> <span class="nf">index_select_ND</span><span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
    <span class="sd">"""Selects the message features from source corresponding to the atom or bond indices in index.</span>
<span class="sd">    """</span>
    <span class="n">index_size</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>             <span class="c1"># (num_atoms/num_bonds, max_num_bonds)</span>
    <span class="n">suffix_dim</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span>        <span class="c1"># (hidden_size,)</span>
    <span class="n">final_size</span> <span class="o">=</span> <span class="n">index_size</span> <span class="o">+</span> <span class="n">suffix_dim</span>  <span class="c1"># (num_atoms/num_bonds, max_num_bonds, hidden_size)</span>

    <span class="n">target</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># (num_atoms/num_bonds * max_num_bonds, hidden_size)</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">final_size</span><span class="p">)</span>                          <span class="c1"># (num_atoms/num_bonds, max_num_bonds, hidden_size)</span>
    <span class="k">return</span> <span class="n">target</span>

<span class="k">class</span> <span class="nc">MolGraph</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">atom_descriptors</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Convert SMILES to RDKit molecule if necessary</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_atoms</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># number of atoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_bonds</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># number of bonds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_atoms</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># mapping from atom index to atom features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_bonds</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># mapping from bond index to concat(in_atom, bond) features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a2b</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># mapping from atom index to incoming bond indices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b2a</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># mapping from bond index to the index of the atom the bond is coming from</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b2revb</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># mapping from bond index to the index of the reverse bond</span>

        <span class="c1"># Get atom features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_atoms</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom_features</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">()]</span>
        <span class="k">if</span> <span class="n">atom_descriptors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f_atoms</span> <span class="o">=</span> <span class="p">[</span><span class="n">f_atoms</span> <span class="o">+</span> <span class="n">descs</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">for</span> <span class="n">f_atoms</span><span class="p">,</span> <span class="n">descs</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_atoms</span><span class="p">,</span> <span class="n">atom_descriptors</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_atoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_atoms</span><span class="p">)</span>

        <span class="c1"># Initialize atom to bond mapping for each atom</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_atoms</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a2b</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>

        <span class="c1"># Get bond features</span>
        <span class="k">for</span> <span class="n">a1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_atoms</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">a2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">a1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_atoms</span><span class="p">):</span>
                <span class="n">bond</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetBondBetweenAtoms</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">bond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">f_bond</span> <span class="o">=</span> <span class="n">bond_features</span><span class="p">(</span><span class="n">bond</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">f_bonds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_atoms</span><span class="p">[</span><span class="n">a1</span><span class="p">]</span> <span class="o">+</span> <span class="n">f_bond</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">f_bonds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_atoms</span><span class="p">[</span><span class="n">a2</span><span class="p">]</span> <span class="o">+</span> <span class="n">f_bond</span><span class="p">)</span>

                <span class="c1"># Update index mappings</span>
                <span class="n">b1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_bonds</span>
                <span class="n">b2</span> <span class="o">=</span> <span class="n">b1</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">a2b</span><span class="p">[</span><span class="n">a2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b1</span><span class="p">)</span>  <span class="c1"># b1 = a1 --&gt; a2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">b2a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">a2b</span><span class="p">[</span><span class="n">a1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b2</span><span class="p">)</span>  <span class="c1"># b2 = a2 --&gt; a1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">b2a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">b2revb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b2</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">b2revb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_bonds</span> <span class="o">+=</span> <span class="mi">2</span>


<span class="k">class</span> <span class="nc">BatchMolGraph</span><span class="p">:</span>
    <span class="sd">"""A `BatchMolGraph` represents the graph structure and featurization of a batch of molecules.</span>
<span class="sd">    """</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol_graphs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MolGraph</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atom_fdim</span> <span class="o">=</span> <span class="n">get_atom_fdim</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bond_fdim</span> <span class="o">=</span> <span class="n">get_bond_fdim</span><span class="p">()</span>

        <span class="c1"># Start n_atoms and n_bonds at 1 b/c zero padding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_atoms</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># number of atoms (start at 1 b/c need index 0 as padding)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_bonds</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># number of bonds (start at 1 b/c need index 0 as padding)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_scope</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of tuples indicating (start_atom_index, num_atoms) for each molecule</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_scope</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of tuples indicating (start_bond_index, num_bonds) for each molecule</span>

        <span class="c1"># All start with zero padding so that indexing with zero padding returns zeros</span>
        <span class="n">f_atoms</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_fdim</span><span class="p">]</span>  <span class="c1"># atom features</span>
        <span class="n">f_bonds</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bond_fdim</span><span class="p">]</span>  <span class="c1"># combined atom/bond features</span>
        <span class="n">a2b</span> <span class="o">=</span> <span class="p">[[]]</span>  <span class="c1"># mapping from atom index to incoming bond indices</span>
        <span class="n">b2a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># mapping from bond index to the index of the atom the bond is coming from</span>
        <span class="n">b2revb</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># mapping from bond index to the index of the reverse bond</span>
        <span class="k">for</span> <span class="n">mol_graph</span> <span class="ow">in</span> <span class="n">mol_graphs</span><span class="p">:</span>
            <span class="n">f_atoms</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">mol_graph</span><span class="o">.</span><span class="n">f_atoms</span><span class="p">)</span>
            <span class="n">f_bonds</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">mol_graph</span><span class="o">.</span><span class="n">f_bonds</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mol_graph</span><span class="o">.</span><span class="n">n_atoms</span><span class="p">):</span>
                <span class="n">a2b</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">b</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_bonds</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">mol_graph</span><span class="o">.</span><span class="n">a2b</span><span class="p">[</span><span class="n">a</span><span class="p">]])</span>

            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mol_graph</span><span class="o">.</span><span class="n">n_bonds</span><span class="p">):</span>
                <span class="n">b2a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_atoms</span> <span class="o">+</span> <span class="n">mol_graph</span><span class="o">.</span><span class="n">b2a</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
                <span class="n">b2revb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_bonds</span> <span class="o">+</span> <span class="n">mol_graph</span><span class="o">.</span><span class="n">b2revb</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">a_scope</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_atoms</span><span class="p">,</span> <span class="n">mol_graph</span><span class="o">.</span><span class="n">n_atoms</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b_scope</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_bonds</span><span class="p">,</span> <span class="n">mol_graph</span><span class="o">.</span><span class="n">n_bonds</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_atoms</span> <span class="o">+=</span> <span class="n">mol_graph</span><span class="o">.</span><span class="n">n_atoms</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_bonds</span> <span class="o">+=</span> <span class="n">mol_graph</span><span class="o">.</span><span class="n">n_bonds</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_num_bonds</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">in_bonds</span><span class="p">)</span> <span class="k">for</span> <span class="n">in_bonds</span> <span class="ow">in</span> <span class="n">a2b</span><span class="p">))</span>  <span class="c1"># max with 1 to fix a crash in rare case of all single-heavy-atom mols</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">f_atoms</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">f_atoms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_bonds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">f_bonds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a2b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="n">a2b</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_num_bonds</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">a2b</span><span class="p">[</span><span class="n">a</span><span class="p">]))</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_atoms</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b2a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">b2a</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b2revb</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">b2revb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b2b</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># try to avoid computing b2b b/c O(n_atoms^3)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a2a</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># only needed if using atom messages</span>

    <span class="k">def</span> <span class="nf">get_components</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom_messages</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span>
                                                                   <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">,</span>
                                                                   <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_bonds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a2b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b2a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b2revb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_scope</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_scope</span>

    <span class="k">def</span> <span class="nf">get_b2b</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">:</span>
        <span class="sd">"""Computes (if necessary) and returns a mapping from each bond index to all the incoming bond indices.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">b2b</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">b2b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a2b</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">b2a</span><span class="p">]</span>  <span class="c1"># num_bonds x max_num_bonds</span>
            <span class="c1"># b2b includes reverse edge for each bond so need to mask out</span>
            <span class="n">revmask</span> <span class="o">=</span> <span class="p">(</span><span class="n">b2b</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b2revb</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">b2b</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>  <span class="c1"># num_bonds x max_num_bonds</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b2b</span> <span class="o">=</span> <span class="n">b2b</span> <span class="o">*</span> <span class="n">revmask</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">b2b</span>

    <span class="k">def</span> <span class="nf">get_a2a</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">:</span>
        <span class="sd">"""Computes (if necessary) and returns a mapping from each atom index to all neighboring atom indices.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">a2a</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># b = a1 --&gt; a2</span>
            <span class="c1"># a2b maps a2 to all incoming bonds b</span>
            <span class="c1"># b2a maps each bond b to the atom it comes from a1</span>
            <span class="c1"># thus b2a[a2b] maps atom a2 to neighboring atoms a1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a2a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b2a</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">a2b</span><span class="p">]</span>  <span class="c1"># num_atoms x max_num_bonds</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">a2a</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># prepare data set</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">MoleculeDataset</span><span class="p">([</span>
    <span class="n">MoleculeDatapoint</span><span class="p">(</span>
        <span class="n">smiles</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">smiles_column</span><span class="p">],</span>
        <span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">target_column</span><span class="p">]]</span>
    <span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span>
<span class="p">])</span>

<span class="c1"># split data into train, validation and test set</span>
<span class="n">random</span> <span class="o">=</span> <span class="n">Random</span><span class="p">()</span>
<span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">]</span>

<span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
<span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>

<span class="n">train_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="n">train_val_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">sizes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

<span class="n">train</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">[:</span><span class="n">train_size</span><span class="p">]]</span>
<span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">[</span><span class="n">train_size</span><span class="p">:</span><span class="n">train_val_size</span><span class="p">]]</span>
<span class="n">test</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">[</span><span class="n">train_val_size</span><span class="p">:]]</span>

<span class="n">train_data</span> <span class="o">=</span> <span class="n">MoleculeDataset</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
<span class="n">val_data</span> <span class="o">=</span> <span class="n">MoleculeDataset</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">MoleculeDataset</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-1-018356360359&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      1</span> <span class="ansi-red-fg"># prepare data set</span>
<span class="ansi-green-fg">----&gt; 2</span><span class="ansi-red-fg"> data = MoleculeDataset([
</span><span class="ansi-green-intense-fg ansi-bold">      3</span>     MoleculeDatapoint(
<span class="ansi-green-intense-fg ansi-bold">      4</span>         smiles<span class="ansi-blue-fg">=</span>row<span class="ansi-blue-fg">[</span>args<span class="ansi-blue-fg">.</span>smiles_column<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span>
<span class="ansi-green-intense-fg ansi-bold">      5</span>         targets<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">[</span>row<span class="ansi-blue-fg">[</span>args<span class="ansi-blue-fg">.</span>target_column<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">]</span>

<span class="ansi-red-fg">NameError</span>: name 'MoleculeDataset' is not defined</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="MPNN-Model">
<a class="anchor" href="#MPNN-Model" aria-hidden="true"><span class="octicon octicon-link"></span></a>MPNN Model<a class="anchor-link" href="#MPNN-Model"> </a>
</h1>
<p>Let's create a MPNN model. The model is composed of encoder and feed-forward network (FFN). The encoder is same as the one we discussed before and the FFN is defined as a straightforward neural network.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Atom feature sizes</span>
<span class="n">MAX_ATOMIC_NUM</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">ATOM_FEATURES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'atomic_num'</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">MAX_ATOMIC_NUM</span><span class="p">)),</span>
    <span class="s1">'degree'</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
    <span class="s1">'formal_charge'</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="s1">'chiral_tag'</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
    <span class="s1">'num_Hs'</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
    <span class="s1">'hybridization'</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">HybridizationType</span><span class="o">.</span><span class="n">SP</span><span class="p">,</span>
        <span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">HybridizationType</span><span class="o">.</span><span class="n">SP2</span><span class="p">,</span>
        <span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">HybridizationType</span><span class="o">.</span><span class="n">SP3</span><span class="p">,</span>
        <span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">HybridizationType</span><span class="o">.</span><span class="n">SP3D</span><span class="p">,</span>
        <span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">HybridizationType</span><span class="o">.</span><span class="n">SP3D2</span>
    <span class="p">],</span>
<span class="p">}</span>

<span class="c1"># Distance feature sizes</span>
<span class="n">PATH_DISTANCE_BINS</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="n">THREE_D_DISTANCE_MAX</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">THREE_D_DISTANCE_STEP</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">THREE_D_DISTANCE_BINS</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">THREE_D_DISTANCE_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">THREE_D_DISTANCE_STEP</span><span class="p">))</span>

<span class="c1"># len(choices) + 1 to include room for uncommon values; + 2 at end for IsAromatic and mass</span>
<span class="n">ATOM_FDIM</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">choices</span> <span class="ow">in</span> <span class="n">ATOM_FEATURES</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">+</span> <span class="mi">2</span>
<span class="n">EXTRA_ATOM_FDIM</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">BOND_FDIM</span> <span class="o">=</span> <span class="mi">14</span>


<span class="k">def</span> <span class="nf">get_atom_fdim</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">"""Gets the dimensionality of the atom feature vector."""</span>
    <span class="k">return</span> <span class="n">ATOM_FDIM</span> <span class="o">+</span> <span class="n">EXTRA_ATOM_FDIM</span>

<span class="k">def</span> <span class="nf">get_bond_fdim</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">"""Gets the dimensionality of the bond feature vector.</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">BOND_FDIM</span> <span class="o">+</span> <span class="n">get_atom_fdim</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">onek_encoding_unk</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">choices</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="n">encoding</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">choices</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">choices</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">encoding</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">encoding</span>

<span class="k">def</span> <span class="nf">atom_features</span><span class="p">(</span><span class="n">atom</span><span class="p">:</span> <span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">Atom</span><span class="p">,</span> <span class="n">functional_groups</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
    <span class="sd">"""Builds a feature vector for an atom.</span>
<span class="sd">    """</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">onek_encoding_unk</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">GetAtomicNum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ATOM_FEATURES</span><span class="p">[</span><span class="s1">'atomic_num'</span><span class="p">])</span> <span class="o">+</span> \
               <span class="n">onek_encoding_unk</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">GetTotalDegree</span><span class="p">(),</span> <span class="n">ATOM_FEATURES</span><span class="p">[</span><span class="s1">'degree'</span><span class="p">])</span> <span class="o">+</span> \
               <span class="n">onek_encoding_unk</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">GetFormalCharge</span><span class="p">(),</span> <span class="n">ATOM_FEATURES</span><span class="p">[</span><span class="s1">'formal_charge'</span><span class="p">])</span> <span class="o">+</span> \
               <span class="n">onek_encoding_unk</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">GetChiralTag</span><span class="p">()),</span> <span class="n">ATOM_FEATURES</span><span class="p">[</span><span class="s1">'chiral_tag'</span><span class="p">])</span> <span class="o">+</span> \
               <span class="n">onek_encoding_unk</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">GetTotalNumHs</span><span class="p">()),</span> <span class="n">ATOM_FEATURES</span><span class="p">[</span><span class="s1">'num_Hs'</span><span class="p">])</span> <span class="o">+</span> \
               <span class="n">onek_encoding_unk</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">GetHybridization</span><span class="p">()),</span> <span class="n">ATOM_FEATURES</span><span class="p">[</span><span class="s1">'hybridization'</span><span class="p">])</span> <span class="o">+</span> \
               <span class="p">[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">GetIsAromatic</span><span class="p">()</span> <span class="k">else</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> \
               <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">GetMass</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.01</span><span class="p">]</span>  <span class="c1"># scaled to about the same range as other features</span>
    <span class="k">if</span> <span class="n">functional_groups</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">features</span> <span class="o">+=</span> <span class="n">functional_groups</span>
    <span class="k">return</span> <span class="n">features</span>


<span class="k">def</span> <span class="nf">initialize_weights</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">"""Initializes the weights of a model in place.</span>
<span class="sd">    """</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_normal_</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MPNEncoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">atom_fdim</span><span class="p">,</span> <span class="n">bond_fdim</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MPNEncoder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atom_fdim</span> <span class="o">=</span> <span class="n">atom_fdim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bond_fdim</span> <span class="o">=</span> <span class="n">bond_fdim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">hidden_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">bias</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">depth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">dropout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers_per_message</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">undirected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atom_messages</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aggregation</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">aggregation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aggregation_norm</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">aggregation_norm</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dropout_layer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">act_func</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cached_zero_vector</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">),</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Input</span>
        <span class="n">input_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bond_fdim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_i</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span>
        <span class="n">w_h_input_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span>

        <span class="c1"># Shared weight matrix across depths (default)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_h</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">w_h_input_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_o</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atom_fdim</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol_graph</span><span class="p">):</span>
        <span class="sd">"""Encodes a batch of molecular graphs.</span>
<span class="sd">        """</span>
        <span class="n">f_atoms</span><span class="p">,</span> <span class="n">f_bonds</span><span class="p">,</span> <span class="n">a2b</span><span class="p">,</span> <span class="n">b2a</span><span class="p">,</span> <span class="n">b2revb</span><span class="p">,</span> <span class="n">a_scope</span><span class="p">,</span> <span class="n">b_scope</span> <span class="o">=</span> <span class="n">mol_graph</span><span class="o">.</span><span class="n">get_components</span><span class="p">()</span>
        <span class="n">f_atoms</span><span class="p">,</span> <span class="n">f_bonds</span><span class="p">,</span> <span class="n">a2b</span><span class="p">,</span> <span class="n">b2a</span><span class="p">,</span> <span class="n">b2revb</span> <span class="o">=</span> <span class="n">f_atoms</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> <span class="n">f_bonds</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> <span class="n">a2b</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> <span class="n">b2a</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> <span class="n">b2revb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="nb">input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_i</span><span class="p">(</span><span class="n">f_bonds</span><span class="p">)</span>  <span class="c1"># num_bonds x hidden_size</span>
        <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">act_func</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>  <span class="c1"># num_bonds x hidden_size</span>

        <span class="c1"># Message passing</span>
        <span class="k">for</span> <span class="n">depth</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># m(a1 -&gt; a2) = [sum_{a0 \in nei(a1)} m(a0 -&gt; a1)] - m(a2 -&gt; a1)</span>
            <span class="c1"># message      a_message = sum(nei_a_message)      rev_message</span>
            <span class="n">nei_a_message</span> <span class="o">=</span> <span class="n">index_select_ND</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">a2b</span><span class="p">)</span>  <span class="c1"># num_atoms x max_num_bonds x hidden</span>
            <span class="n">a_message</span> <span class="o">=</span> <span class="n">nei_a_message</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># num_atoms x hidden</span>
            <span class="n">rev_message</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="n">b2revb</span><span class="p">]</span>  <span class="c1"># num_bonds x hidden</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">a_message</span><span class="p">[</span><span class="n">b2a</span><span class="p">]</span> <span class="o">-</span> <span class="n">rev_message</span>  <span class="c1"># num_bonds x hidden</span>

            <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_h</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">act_func</span><span class="p">(</span><span class="nb">input</span> <span class="o">+</span> <span class="n">message</span><span class="p">)</span>  <span class="c1"># num_bonds x hidden_size</span>
            <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout_layer</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>  <span class="c1"># num_bonds x hidden</span>

        <span class="n">a2x</span> <span class="o">=</span> <span class="n">a2b</span>
        <span class="n">nei_a_message</span> <span class="o">=</span> <span class="n">index_select_ND</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">a2x</span><span class="p">)</span>  <span class="c1"># num_atoms x max_num_bonds x hidden</span>
        <span class="n">a_message</span> <span class="o">=</span> <span class="n">nei_a_message</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># num_atoms x hidden</span>
        <span class="n">a_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">f_atoms</span><span class="p">,</span> <span class="n">a_message</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># num_atoms x (atom_fdim + hidden)</span>
        <span class="n">atom_hiddens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">act_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W_o</span><span class="p">(</span><span class="n">a_input</span><span class="p">))</span>  <span class="c1"># num_atoms x hidden</span>
        <span class="n">atom_hiddens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout_layer</span><span class="p">(</span><span class="n">atom_hiddens</span><span class="p">)</span>  <span class="c1"># num_atoms x hidden</span>

        <span class="c1"># Readout</span>
        <span class="n">mol_vecs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">a_start</span><span class="p">,</span> <span class="n">a_size</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">a_scope</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">a_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">mol_vecs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cached_zero_vector</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cur_hiddens</span> <span class="o">=</span> <span class="n">atom_hiddens</span><span class="o">.</span><span class="n">narrow</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">a_start</span><span class="p">,</span> <span class="n">a_size</span><span class="p">)</span>
                <span class="n">mol_vec</span> <span class="o">=</span> <span class="n">cur_hiddens</span>  <span class="c1"># (num_atoms, hidden_size)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregation</span> <span class="o">==</span> <span class="s1">'mean'</span><span class="p">:</span>
                    <span class="n">mol_vec</span> <span class="o">=</span> <span class="n">mol_vec</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">a_size</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregation</span> <span class="o">==</span> <span class="s1">'sum'</span><span class="p">:</span>
                    <span class="n">mol_vec</span> <span class="o">=</span> <span class="n">mol_vec</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregation</span> <span class="o">==</span> <span class="s1">'norm'</span><span class="p">:</span>
                    <span class="n">mol_vec</span> <span class="o">=</span> <span class="n">mol_vec</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregation_norm</span>
                <span class="n">mol_vecs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mol_vec</span><span class="p">)</span>

        <span class="n">mol_vecs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">mol_vecs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># (num_molecules, hidden_size)</span>

        <span class="k">return</span> <span class="n">mol_vecs</span>  <span class="c1"># num_molecules x hidden</span>
    

<span class="k">class</span> <span class="nc">MPN</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">atom_fdim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bond_fdim</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MPN</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atom_fdim</span> <span class="o">=</span> <span class="n">atom_fdim</span> <span class="ow">or</span> <span class="n">get_atom_fdim</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bond_fdim</span> <span class="o">=</span> <span class="n">bond_fdim</span> <span class="ow">or</span> <span class="n">get_bond_fdim</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">MPNEncoder</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_fdim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bond_fdim</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="sd">"""Encodes a batch of molecules.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="n">BatchMolGraph</span><span class="p">:</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="p">[</span><span class="n">mol2graph</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>

        <span class="n">encodings</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">encodings</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>
    

<span class="k">class</span> <span class="nc">MoleculeModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">featurizer</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MoleculeModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">classification</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">dataset_type</span> <span class="o">==</span> <span class="s1">'classification'</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">featurizer</span> <span class="o">=</span> <span class="n">featurizer</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">num_tasks</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">classification</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">create_encoder</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_ffn</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

        <span class="n">initialize_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_encoder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">MPN</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_ffn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">first_linear_dim</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">hidden_size</span>
        <span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">dropout</span><span class="p">)</span>
        <span class="n">activation</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>

        <span class="c1"># Create FFN layers</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">ffn_num_layers</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ffn</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">dropout</span><span class="p">,</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">first_linear_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ffn</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">dropout</span><span class="p">,</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">first_linear_dim</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">ffn_hidden_size</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">ffn_num_layers</span> <span class="o">-</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">ffn</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                    <span class="n">activation</span><span class="p">,</span>
                    <span class="n">dropout</span><span class="p">,</span>
                    <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">ffn_hidden_size</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">ffn_hidden_size</span><span class="p">),</span>
                <span class="p">])</span>
            <span class="n">ffn</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                <span class="n">activation</span><span class="p">,</span>
                <span class="n">dropout</span><span class="p">,</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">ffn_hidden_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">),</span>
            <span class="p">])</span>

        <span class="c1"># Create FFN model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ffn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">ffn</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">featurize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">features_batch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">atom_descriptors_batch</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">"""Computes feature vectors of the input by running the model except for the last layer.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ffn</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">features_batch</span><span class="p">,</span> <span class="n">atom_descriptors_batch</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ffn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">batch</span><span class="p">))</span>

        <span class="c1"># Don't apply sigmoid during training b/c using BCEWithLogitsLoss</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">classification</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">output</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">MoleculeModel</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As it is shown below, the model is comprised of an encoder and FFN. The encoder has three learned matrices and the FFN has 2 fully-connected layers.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>MoleculeModel(
  (encoder): MPN(
    (encoder): MPNEncoder(
      (dropout_layer): Dropout(p=0.0, inplace=False)
      (act_func): ReLU()
      (W_i): Linear(in_features=147, out_features=300, bias=False)
      (W_h): Linear(in_features=300, out_features=300, bias=False)
      (W_o): Linear(in_features=433, out_features=300, bias=True)
    )
  )
  (ffn): Sequential(
    (0): Dropout(p=0.0, inplace=False)
    (1): Linear(in_features=300, out_features=300, bias=True)
    (2): ReLU()
    (3): Dropout(p=0.0, inplace=False)
    (4): Linear(in_features=300, out_features=1, bias=True)
  )
)</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Train-the-MPNN">
<a class="anchor" href="#Train-the-MPNN" aria-hidden="true"><span class="octicon octicon-link"></span></a>Train the MPNN<a class="anchor-link" href="#Train-the-MPNN"> </a>
</h1>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">torch.optim.lr_scheduler</span> <span class="kn">import</span> <span class="n">_LRScheduler</span>
<span class="kn">from</span> <span class="nn">torch.optim</span> <span class="kn">import</span> <span class="n">Adam</span><span class="p">,</span> <span class="n">Optimizer</span>

<span class="k">class</span> <span class="nc">NoamLR</span><span class="p">(</span><span class="n">_LRScheduler</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Noam learning rate scheduler with piecewise linear increase and exponential decay.</span>

<span class="sd">    The learning rate increases linearly from init_lr to max_lr over the course of</span>
<span class="sd">    the first warmup_steps (where :code:`warmup_steps = warmup_epochs * steps_per_epoch`).</span>
<span class="sd">    Then the learning rate decreases exponentially from :code:`max_lr` to :code:`final_lr` over the</span>
<span class="sd">    course of the remaining :code:`total_steps - warmup_steps` (where :code:`total_steps =</span>
<span class="sd">    total_epochs * steps_per_epoch`). This is roughly based on the learning rate</span>
<span class="sd">    schedule from `Attention is All You Need &lt;https://arxiv.org/abs/1706.03762&gt;`_, section 5.3.</span>
<span class="sd">    """</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">optimizer</span><span class="p">:</span> <span class="n">Optimizer</span><span class="p">,</span>
                 <span class="n">warmup_epochs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
                 <span class="n">total_epochs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
                 <span class="n">steps_per_epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">init_lr</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                 <span class="n">max_lr</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                 <span class="n">final_lr</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]):</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">warmup_epochs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">total_epochs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">init_lr</span><span class="p">)</span> <span class="o">==</span> \
               <span class="nb">len</span><span class="p">(</span><span class="n">max_lr</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">final_lr</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_lrs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warmup_epochs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">warmup_epochs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_epochs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">total_epochs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps_per_epoch</span> <span class="o">=</span> <span class="n">steps_per_epoch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_lr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">init_lr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_lr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">max_lr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final_lr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">final_lr</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_step</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="n">init_lr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warmup_steps</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">warmup_epochs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_per_epoch</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_epochs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_per_epoch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linear_increment</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_lr</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_lr</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">warmup_steps</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">exponential_gamma</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_lr</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_lr</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_steps</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">warmup_steps</span><span class="p">))</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">NoamLR</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">optimizer</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_lr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">current_step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_step</span> <span class="o">=</span> <span class="n">current_step</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_step</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_lrs</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_step</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">warmup_steps</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_lr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_step</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear_increment</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_step</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_steps</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_lr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exponential_gamma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_step</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">warmup_steps</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># theoretically this case should never be reached since training should stop at total_steps</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_lr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">'lr'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">threading</span>

<span class="k">def</span> <span class="nf">construct_molecule_batch</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">MoleculeDataset</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">data</span><span class="o">.</span><span class="n">batch_graph</span><span class="p">()</span>  <span class="c1"># Forces computation and caching of the BatchMolGraph for the molecules</span>
    <span class="k">return</span> <span class="n">data</span>

<span class="k">class</span> <span class="nc">MoleculeSampler</span><span class="p">(</span><span class="n">Sampler</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Sampler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_random</span> <span class="o">=</span> <span class="n">Random</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positive_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">negative_indices</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">)))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span>
    

<span class="k">class</span> <span class="nc">MoleculeDataLoader</span><span class="p">(</span><span class="n">DataLoader</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">dataset</span><span class="p">:</span> <span class="n">MoleculeDataset</span><span class="p">,</span>
                 <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
                 <span class="n">num_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
                 <span class="n">shuffle</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span> <span class="o">=</span> <span class="n">dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_workers</span> <span class="o">=</span> <span class="n">num_workers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seed</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_context</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_class_balance</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">is_main_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span> <span class="ow">is</span> <span class="n">threading</span><span class="o">.</span><span class="n">main_thread</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_main_thread</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_workers</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_context</span> <span class="o">=</span> <span class="s1">'forkserver'</span>  <span class="c1"># In order to prevent a hanging</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="o">=</span> <span class="mi">3600</span>  <span class="c1"># Just for sure that the DataLoader won't hang</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sampler</span> <span class="o">=</span> <span class="n">MoleculeSampler</span><span class="p">(</span>
            <span class="n">dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_shuffle</span><span class="p">,</span>
            <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_seed</span>
        <span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">MoleculeDataLoader</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_batch_size</span><span class="p">,</span>
            <span class="n">sampler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_sampler</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_workers</span><span class="p">,</span>
            <span class="n">collate_fn</span><span class="o">=</span><span class="n">construct_molecule_batch</span><span class="p">,</span>
            <span class="n">multiprocessing_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">targets</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_class_balance</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shuffle</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'Cannot safely extract targets when class balance or shuffle are enabled.'</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">targets</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampler</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">iter_size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sampler</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">MoleculeDataset</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MoleculeDataLoader</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Create data loaders</span>
<span class="n">train_data_loader</span> <span class="o">=</span> <span class="n">MoleculeDataLoader</span><span class="p">(</span>
    <span class="n">dataset</span><span class="o">=</span><span class="n">train_data</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
    <span class="n">num_workers</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">seed</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span>
<span class="p">)</span>
<span class="n">val_data_loader</span> <span class="o">=</span> <span class="n">MoleculeDataLoader</span><span class="p">(</span>
    <span class="n">dataset</span><span class="o">=</span><span class="n">val_data</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
    <span class="n">num_workers</span><span class="o">=</span><span class="mi">8</span>
<span class="p">)</span>
<span class="n">test_data_loader</span> <span class="o">=</span> <span class="n">MoleculeDataLoader</span><span class="p">(</span>
    <span class="n">dataset</span><span class="o">=</span><span class="n">test_data</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
    <span class="n">num_workers</span><span class="o">=</span><span class="mi">8</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># optimizer</span>
<span class="n">params</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">'params'</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="s1">'lr'</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">init_lr</span><span class="p">,</span> <span class="s1">'weight_decay'</span><span class="p">:</span> <span class="mi">0</span><span class="p">}]</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

<span class="c1"># scheduler</span>
<span class="n">scheduler</span> <span class="o">=</span> <span class="n">NoamLR</span><span class="p">(</span>
    <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
    <span class="n">warmup_epochs</span><span class="o">=</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">warmup_epochs</span><span class="p">],</span>
    <span class="n">total_epochs</span><span class="o">=</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">epochs</span><span class="p">]</span> <span class="o">*</span> <span class="n">args</span><span class="o">.</span><span class="n">num_lrs</span><span class="p">,</span>
    <span class="n">steps_per_epoch</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span> <span class="o">//</span> <span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
    <span class="n">init_lr</span><span class="o">=</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">init_lr</span><span class="p">],</span>
    <span class="n">max_lr</span><span class="o">=</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">max_lr</span><span class="p">],</span>
    <span class="n">final_lr</span><span class="o">=</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">final_lr</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># loss function</span>
<span class="n">loss_func</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="s1">'none'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># train loop</span>
<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<span class="n">loss_sum</span> <span class="o">=</span> <span class="n">iter_count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">n_iter</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">train_data_loader</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">train_data_loader</span><span class="p">),</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">mol_batch</span><span class="p">,</span> <span class="n">target_batch</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">batch_graph</span><span class="p">(),</span> <span class="n">batch</span><span class="o">.</span><span class="n">targets</span><span class="p">()</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([[</span><span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tb</span><span class="p">]</span> <span class="k">for</span> <span class="n">tb</span> <span class="ow">in</span> <span class="n">target_batch</span><span class="p">])</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([[</span><span class="mi">0</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tb</span><span class="p">]</span> <span class="k">for</span> <span class="n">tb</span> <span class="ow">in</span> <span class="n">target_batch</span><span class="p">])</span>

    <span class="c1"># Run model</span>
    <span class="n">model</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">mol_batch</span><span class="p">)</span>

    <span class="c1"># Move tensors to correct device</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">preds</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">preds</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">class_weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">targets</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">preds</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_func</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span> <span class="o">*</span> <span class="n">class_weights</span> <span class="o">*</span> <span class="n">mask</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">loss_sum</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="n">iter_count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>

    <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scheduler</span><span class="p">,</span> <span class="n">NoamLR</span><span class="p">):</span>
        <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

    <span class="n">n_iter</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Training for the first epoch is finished. Let's take a look at how well the model predict the ClogP.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

<span class="n">initial_preds</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">val_data_loader</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># Prepare batch</span>
    <span class="n">batch</span><span class="p">:</span> <span class="n">MoleculeDataset</span>
    <span class="n">mol_batch</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">batch_graph</span><span class="p">()</span>

    <span class="c1"># Make predictions</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">batch_preds</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">mol_batch</span><span class="p">)</span>

    <span class="n">batch_preds</span> <span class="o">=</span> <span class="n">batch_preds</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="c1"># Collect vectors</span>
    <span class="n">batch_preds</span> <span class="o">=</span> <span class="n">batch_preds</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">initial_preds</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">batch_preds</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span>

<span class="c1"># valid_preds and valid_targets have shape (num_tasks, data_size)</span>
<span class="n">targets</span> <span class="o">=</span> <span class="n">val_data_loader</span><span class="o">.</span><span class="n">targets</span>
<span class="n">metric_func</span> <span class="o">=</span> <span class="n">mean_squared_error</span>

<span class="n">valid_preds</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">num_tasks</span><span class="p">)]</span>
<span class="n">valid_targets</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">num_tasks</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">num_tasks</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">preds</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">targets</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Skip those without targets</span>
            <span class="n">valid_preds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
            <span class="n">valid_targets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">targets</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
            
<span class="n">result</span> <span class="o">=</span> <span class="n">metric_func</span><span class="p">(</span><span class="n">valid_targets</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">valid_preds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'MSE:'</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>MSE: 3.0658553721115887
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">fit</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">valid_targets</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">valid_preds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'Target ClogP'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'Predicted ClogP'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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%0A">
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Almost no correlation as of first epoch. Let's train a few more epochs and see if the prediciton improves.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">scheduler</span> <span class="o">=</span> <span class="n">NoamLR</span><span class="p">(</span>
    <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
    <span class="n">warmup_epochs</span><span class="o">=</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">warmup_epochs</span><span class="p">],</span>
    <span class="n">total_epochs</span><span class="o">=</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">epochs</span><span class="p">]</span> <span class="o">*</span> <span class="n">args</span><span class="o">.</span><span class="n">num_lrs</span><span class="p">,</span>
    <span class="n">steps_per_epoch</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span> <span class="o">//</span> <span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
    <span class="n">init_lr</span><span class="o">=</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">init_lr</span><span class="p">],</span>
    <span class="n">max_lr</span><span class="o">=</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">max_lr</span><span class="p">],</span>
    <span class="n">final_lr</span><span class="o">=</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">final_lr</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">loss_func</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="s1">'none'</span><span class="p">)</span>

<span class="n">optimizer</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

<span class="n">metric_func</span> <span class="o">=</span> <span class="n">mean_squared_error</span>


<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">epochs</span><span class="p">)):</span>

    <span class="c1"># train </span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

    <span class="n">loss_sum</span> <span class="o">=</span> <span class="n">iter_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">n_iter</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">train_data_loader</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">train_data_loader</span><span class="p">),</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">mol_batch</span><span class="p">,</span> <span class="n">target_batch</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">batch_graph</span><span class="p">(),</span> <span class="n">batch</span><span class="o">.</span><span class="n">targets</span><span class="p">()</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([[</span><span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tb</span><span class="p">]</span> <span class="k">for</span> <span class="n">tb</span> <span class="ow">in</span> <span class="n">target_batch</span><span class="p">])</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([[</span><span class="mi">0</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tb</span><span class="p">]</span> <span class="k">for</span> <span class="n">tb</span> <span class="ow">in</span> <span class="n">target_batch</span><span class="p">])</span>

        <span class="c1"># Run model</span>
        <span class="n">model</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">mol_batch</span><span class="p">)</span>

        <span class="c1"># Move tensors to correct device</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">preds</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">preds</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">class_weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">targets</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">preds</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_func</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span> <span class="o">*</span> <span class="n">class_weights</span> <span class="o">*</span> <span class="n">mask</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="n">loss_sum</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">iter_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>

        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scheduler</span><span class="p">,</span> <span class="n">NoamLR</span><span class="p">):</span>
            <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

        <span class="n">n_iter</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

    <span class="c1"># eval</span>

    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

    <span class="n">preds</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">val_data_loader</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># Prepare batch</span>
        <span class="n">batch</span><span class="p">:</span> <span class="n">MoleculeDataset</span>
        <span class="n">mol_batch</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">batch_graph</span><span class="p">()</span>

        <span class="c1"># Make predictions</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">batch_preds</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">mol_batch</span><span class="p">)</span>

        <span class="n">batch_preds</span> <span class="o">=</span> <span class="n">batch_preds</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

        <span class="c1"># Collect vectors</span>
        <span class="n">batch_preds</span> <span class="o">=</span> <span class="n">batch_preds</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">preds</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">batch_preds</span><span class="p">)</span>

    <span class="c1"># valid_preds and valid_targets have shape (num_tasks, data_size)</span>
    <span class="n">num_tasks</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="n">val_data_loader</span><span class="o">.</span><span class="n">targets</span>

    <span class="n">valid_preds</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_tasks</span><span class="p">)]</span>
    <span class="n">valid_targets</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_tasks</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_tasks</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">preds</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">targets</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Skip those without targets</span>
                <span class="n">valid_preds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                <span class="n">valid_targets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">targets</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">metric_func</span><span class="p">(</span><span class="n">valid_targets</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">valid_preds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>0 0.5059666700564436
1 0.6747574089163861
2 0.29365952162247105
3 0.2443422001168768
4 0.22893787807471938
5 0.24693692581926335
6 0.18068380381421822
7 0.16628313459548472
8 0.15646424430563233
9 0.14714968670153764
10 0.1484021422019028
11 0.1497949169195903
12 0.1332405691696682
13 0.12293908860736892
14 0.12480342381848945
15 0.12231600820223316
16 0.12469534214189118
17 0.12742151396520932
18 0.10947115821963195
19 0.11363330373825292
20 0.10276127977714987
21 0.10135583119599778
22 0.10164295643187546
23 0.09673642613524305
24 0.09645447176601984
25 0.0980465410170695
26 0.09245372955020192
27 0.08906743111716783
28 0.0879800185507161
29 0.09138532813108272
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Over the course of training 30 epochs, the MSE quickly improved and reached to less than 0.1 at the end! Let's take a look at the target vs predicted values. So, we got to this level of prediction without ever specifically wrote code for computing ClogP.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">fit</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">valid_targets</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">valid_preds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'Target ClogP'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'Predicted ClogP'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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%0A">
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Conclusion">
<a class="anchor" href="#Conclusion" aria-hidden="true"><span class="octicon octicon-link"></span></a>Conclusion<a class="anchor-link" href="#Conclusion"> </a>
</h1>
<p>In this post, I have trained a graph neural network that can predict ClogP property. Within 30 epochs, it was able to predict the property pretty accurately in less than 0.1 MSE. Given only very simple features were used in atom and bond features, it was able to "learn" to predict the property fairly quickly.</p>
<p>Now that we have a trained model, a few things I'd like to try:</p>
<ul>
<li>compare this model with other traditional model and compare performance</li>
<li>try different parameters, such as <code>depth</code>
</li>
<li>try alternative featurization, i.e., add if bond is rotatable in the bond_features and so on.</li>
<li>add long-range connection;current network is limited to chemical bonds, but longer range interaction may also be important.</li>
</ul>

</div>
</div>
</div>
</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="sunhwan/blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/blog/2021/03/07/Learning-Molecular-Representation-Using-Graph-Neural-Network-Training-Molecular-Graph.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/blog/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/blog/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/blog/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Computational chemist. Personal blog for code and science.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/sunhwan" title="sunhwan"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/sunhwan" title="sunhwan"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
