<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Run Molecular Dynamics Simulation on Container and AWS Batch | Sunhwan Jo</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Run Molecular Dynamics Simulation on Container and AWS Batch" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Run MD simulation on a dockerized container and AWS Batch as a simple scheduler" />
<meta property="og:description" content="Run MD simulation on a dockerized container and AWS Batch as a simple scheduler" />
<link rel="canonical" href="https://sunhwan.github.io/blog/2021/04/27/Run-Molecular-Dynamics-Simulation-on-Container-and-AWS-Batch.html" />
<meta property="og:url" content="https://sunhwan.github.io/blog/2021/04/27/Run-Molecular-Dynamics-Simulation-on-Container-and-AWS-Batch.html" />
<meta property="og:site_name" content="Sunhwan Jo" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-04-27T00:00:00-05:00" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"https://sunhwan.github.io/blog/2021/04/27/Run-Molecular-Dynamics-Simulation-on-Container-and-AWS-Batch.html"},"url":"https://sunhwan.github.io/blog/2021/04/27/Run-Molecular-Dynamics-Simulation-on-Container-and-AWS-Batch.html","@type":"BlogPosting","headline":"Run Molecular Dynamics Simulation on Container and AWS Batch","dateModified":"2021-04-27T00:00:00-05:00","datePublished":"2021-04-27T00:00:00-05:00","description":"Run MD simulation on a dockerized container and AWS Batch as a simple scheduler","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/blog/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://sunhwan.github.io/blog/feed.xml" title="Sunhwan Jo" /><link rel="shortcut icon" type="image/x-icon" href="/blog/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/blog/">Sunhwan Jo</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/blog/about/">About Me</a><a class="page-link" href="/blog/search/">Search</a><a class="page-link" href="/blog/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Run Molecular Dynamics Simulation on Container and AWS Batch</h1><p class="page-description">Run MD simulation on a dockerized container and AWS Batch as a simple scheduler</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-04-27T00:00:00-05:00" itemprop="datePublished">
        Apr 27, 2021
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      6 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/blog/categories/#Cloud">Cloud</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#MD Simulation">MD Simulation</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#initial-configuration">Initial Configuration</a></li>
<li class="toc-entry toc-h2"><a href="#prepare-containerized-md-simulation">Prepare Containerized MD Simulation</a></li>
<li class="toc-entry toc-h2"><a href="#submit-test-job">Submit Test Job</a></li>
<li class="toc-entry toc-h2"><a href="#more-realistic-test">More Realistic Test</a></li>
<li class="toc-entry toc-h2"><a href="#conclusion">Conclusion</a></li>
</ul><p><strong>AWS and other cloud platform offers flexible computing resources at a reasonable price. There are many ways to take advantage of such cloud resource. In the <a href="https://sunhwan.github.io/blog/2021/04/17/Run-Molecular-Dynamics-Simulation-on-AWS-Cluster.html">last post</a>, I examined running MD simulation using AWS Parallel Cluster. Here, I’m going to show you how to run MD simulation using AWS Batch</strong></p>

<p>I used these articles when I wrote this post. It may be helpful for you as well:</p>
<ul>
  <li><a href="https://aws.amazon.com/blogs/compute/creating-an-aws-batch-environment-for-mixed-cpu-and-gpu-genomics-workflows/">Creating an AWS Batch environment for mixed CPU and GPU genomics workflows
</a></li>
  <li><a href="https://aws.amazon.com/blogs/compute/creating-a-simple-fetch-and-run-aws-batch-job/">Creating a Simple “Fetch &amp; Run” AWS Batch Job
</a></li>
</ul>

<h2 id="initial-configuration">
<a class="anchor" href="#initial-configuration" aria-hidden="true"><span class="octicon octicon-link"></span></a>Initial Configuration</h2>

<p>AWS Batch acts as a simple queuing system where the user can submit a task that can be ran on containers. We will have to create a compute environment on AWS Batch first. I created a managed compute environment, named <code class="language-plaintext highlighter-rouge">gpu</code> using AWS Batch Dashboard. I selected provision model as <code class="language-plaintext highlighter-rouge">spot</code> and allowed instances as <code class="language-plaintext highlighter-rouge">p2</code> and <code class="language-plaintext highlighter-rouge">p3</code>. I set <code class="language-plaintext highlighter-rouge">Maximum % on-demand price</code> as <code class="language-plaintext highlighter-rouge">100%</code>, which means, my instance will be terminated when the price of spot instance goes over 100% of the on-demand instance price.</p>

<p>Next, create a job queue called <code class="language-plaintext highlighter-rouge">gpu</code> and make it use the <code class="language-plaintext highlighter-rouge">gpu</code> compute environment we just created.</p>

<h2 id="prepare-containerized-md-simulation">
<a class="anchor" href="#prepare-containerized-md-simulation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Prepare Containerized MD Simulation</h2>

<p>Next, we prepare a Docker image for MD simulation. This Docker image will be used in a task. For a test, let’s prepare a very simple Dockerfile and use it for AWS Batch.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM nvidia/cuda:11.3.0-base-ubuntu18.04 as base

ENV PATH="/root/miniconda3/bin:${PATH}"
ARG PATH="/root/miniconda3/bin:${PATH}"
RUN apt-get update

RUN apt-get install -y wget &amp;&amp; rm -rf /var/lib/apt/lists/*

RUN wget \
    https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh \
    &amp;&amp; mkdir /root/.conda \
    &amp;&amp; bash Miniconda3-latest-Linux-x86_64.sh -b \
    &amp;&amp; rm -f Miniconda3-latest-Linux-x86_64.sh
RUN conda --version

RUN conda install -c conda-forge openmm
</code></pre></div></div>

<p>I built the image and uploaded to Docker hub as <code class="language-plaintext highlighter-rouge">sunhwan/openmm</code>.</p>

<p>Next, let’s create a job definition from the AWS Batch Dashboard. I selected platform as <code class="language-plaintext highlighter-rouge">EC2</code>, image as <code class="language-plaintext highlighter-rouge">sunhwan/openmm</code>, and selected the number of GPUs as <code class="language-plaintext highlighter-rouge">1</code>.</p>

<p>Command parameter in the job definition is what gets executed after initialize the Docker image. Because this is a test, let’s use <code class="language-plaintext highlighter-rouge">python -m simtk.testInstallation</code> for the command.</p>

<h2 id="submit-test-job">
<a class="anchor" href="#submit-test-job" aria-hidden="true"><span class="octicon octicon-link"></span></a>Submit Test Job</h2>

<p>This is straightforward using the AWS Batch Dashboard. Select <code class="language-plaintext highlighter-rouge">Submit New Job</code> menu from the dashboard and select the job queue and the job definition we just created. It should populate default option for you. Select <code class="language-plaintext highlighter-rouge">Submit</code> at the bottom of the page, and Voilà, the job is submitted. Wait a few seconds (or minutes) and you should be able to see the job is being processed and finished running.</p>

<p>To check the output, you will have to check the log stream in the jobs detail page. Below is from my test.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--------------------------------------------------------------------------
|   timestamp   |                        message                         |
|---------------|--------------------------------------------------------|
| 1619451128901 | OpenMM Version: 7.5                                    |
| 1619451128901 | Git Revision: b49b82efb5a253a7c891ca084b3370e181de2ea3 |
| 1619451128901 | There are 3 Platforms available:                       |
| 1619451128901 | 1 Reference - Successfully computed forces             |
| 1619451128901 | 2 CPU - Successfully computed forces                   |
| 1619451128901 | 3 CUDA - Successfully computed forces                  |
| 1619451128901 | Median difference in forces between platforms:         |
| 1619451128901 | Reference vs. CPU: 6.29939e-06                         |
| 1619451128901 | Reference vs. CUDA: 6.72706e-06                        |
| 1619451128901 | CPU vs. CUDA: 7.36308e-07                              |
| 1619451128901 | All differences are within tolerance.                  |
--------------------------------------------------------------------------
</code></pre></div></div>

<h2 id="more-realistic-test">
<a class="anchor" href="#more-realistic-test" aria-hidden="true"><span class="octicon octicon-link"></span></a>More Realistic Test</h2>

<p>Let’s try a more general example. Let’s create a job definition that can take script (and input structure) from AWS S3, run MD simulation, and store the output back on the S3 storage.</p>

<p><img src="/blog/assets/figures/awsbatch.png" alt="AWS Arrangement"></p>

<p>To achieve this, we need to prepare several settings:</p>

<ol>
  <li>
    <p>S3 bucket</p>

    <p>Create an S3 bucket for storing input script (or structure) and output.</p>
  </li>
  <li>
    <p>IAM Role</p>

    <p>Create an IAM roles that allows containers launched from jobs to access S3 storage. I created a role named <code class="language-plaintext highlighter-rouge">aws-batch-s3-access</code> for <code class="language-plaintext highlighter-rouge">Elastic Container Service</code> &gt; <code class="language-plaintext highlighter-rouge">Elastic Container Service Task</code> &gt; <code class="language-plaintext highlighter-rouge">AmazonS3FullAccess</code>.</p>
  </li>
  <li>
    <p>Dockerfile</p>

    <p>Based on the Dockerfile used in the previous section, I expanded it to install AWS CLI and use <code class="language-plaintext highlighter-rouge">fetch_and_run.sh</code> script as an entrypoint script. The <code class="language-plaintext highlighter-rouge">fetch_and_run.sh</code> simply download files from S3 using the user supplied environment variable (set in job definition).</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>FROM sunhwan/openmm as base
FROM nvidia/cuda:11.3.0-base-ubuntu18.04

ENV PATH="/root/miniconda3/bin:${PATH}"
ARG PATH="/root/miniconda3/bin:${PATH}"

RUN apt-get update &amp;&amp; apt-get install -y unzip wget

COPY --from=base /root/miniconda3/. /root/miniconda3

RUN wget "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" &amp;&amp; \
    unzip awscli-exe-linux-x86_64.zip &amp;&amp; \
    ./aws/install &amp;&amp; \
    rm -rf ./aws

ADD fetch_and_run.sh /usr/local/bin/fetch_and_run.sh
WORKDIR /tmp

ENTRYPOINT ["/usr/local/bin/fetch_and_run.sh"]
</code></pre></div>    </div>
  </li>
  <li>
    <p>Upload job script to S3 bucket. I uploaded the following job script to S3. This file will be provided to job as a parameter.</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ cat &gt; myjob.sh &lt;&lt;EOF
#!/bin/bash

date
echo "Args: $@"
env
echo "This is my simple test job!."
echo "jobId: $AWS_BATCH_JOB_ID"

wget https://sunhwan.github.io/blog/assets/examples/cloudmd/charmm-gui-181l-openmm.tar.gz
tar -xvzf charmm-gui-181l-openmm.tar.gz

# prepare Slurm job script
cd charmm-gui-1894063249/openmm

/bin/bash run.sh
EOF

$ aws s3 cp myjob.sh s3://&lt;bucket&gt;/myjob.sh
</code></pre></div>    </div>
  </li>
</ol>

<p>That’s a lot of boilerplate! All is left is to revise the job definition file to submit a job. Note that we need to supply the IAM role for S3 access and the environment variables for <code class="language-plaintext highlighter-rouge">fetch_and_run.sh</code> script. The job script should</p>

<p><img src="/blog/assets/figures/awsbatch_jobdefinition.png" alt="AWS Job Definition"></p>

<p>A job submitted with this definition will sit in a job queue for a while (it took me more time because I selected spot pricing and it appears the price at the moment was higher than what I asked) then started running and finished in about an hour after running the simulation.</p>

<p>My job script does not handles restarting in container properly. To handle this properly, the checkpoint file has to be written on S3 to make it persistent and examine if there’s any restart file in S3 storage when a new job started.</p>

<h2 id="conclusion">
<a class="anchor" href="#conclusion" aria-hidden="true"><span class="octicon octicon-link"></span></a>Conclusion</h2>

<p>In the <a href="https://sunhwan.github.io/blog/2021/04/17/Run-Molecular-Dynamics-Simulation-on-AWS-Cluster.html">last post</a>, I used AWS <code class="language-plaintext highlighter-rouge">parallel-cluster</code> to build a cluster quickly and ran MD simulation on GPU instance. This is great for users quickly test system setup and run MD simulation all at the same time.</p>

<p>This time, I looked at how I can set up MD simulation using Docker container and AWS Batch as a scheduler. Using container is great because my simulation will always run at a controlled environment. In addition, we now don’t have to maintain the master node because container image can be tested/deployed from a laptop.</p>

<p>Using AWS Batch and container does require more setup up front, however, if the tasks are well-defined and if the tasks do not change often, then it is a great way to simplify task setup and management. As an added benefit, all job definition/task submission can be done from a command line (using AWS CLI) or can be done progamatically using AWS API. It is probably very useful to set up some kind of high-throughput workflow that use MD simulation (e.g., docking -&gt; run MM/GBSA or some adaptive MD simulation algorithm) when it is coupled with workflow scripts such as AWS Step Function.</p>

<p>One aspect that I find it challenging is how to bring files in and out of the container. I used S3 in this example, but I found this more cumbersome. Probably there are more convenient file storage options available for AWS container tasks.</p>

  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="sunhwan/blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/blog/2021/04/27/Run-Molecular-Dynamics-Simulation-on-Container-and-AWS-Batch.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/blog/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/blog/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/blog/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Computational chemist. Personal blog for code and science.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/sunhwan" title="sunhwan"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/sunhwan" title="sunhwan"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
